// VibeAI Code Studio - Exakt wie VS Code
// Mit Live Preview, AI Chat, Auto-Fix, 40+ Sprachen
'use client';

import { useState, useEffect, useRef } from 'react';

export default function CodeStudio() {
  const [files, setFiles] = useState([
    { id: 1, name: 'index.html', content: '<h1>Hello VibeAI</h1><p>Live Preview aktiv!</p>', language: 'html' },
    { id: 2, name: 'app.js', content: 'console.log("VibeAI Code Studio");', language: 'javascript' }
  ]);
  const [activeFile, setActiveFile] = useState(files[0]);
  const [showPreview, setShowPreview] = useState(true);
  const [showAIChat, setShowAIChat] = useState(false);
  const [output, setOutput] = useState('');
  const [aiMessages, setAiMessages] = useState([]);
  const [previewDevice, setPreviewDevice] = useState('desktop');
  
  const editorRef = useRef(null);
  const previewRef = useRef(null);

  // Live Preview Update
  const updatePreview = () => {
    if (previewRef.current && activeFile.language === 'html') {
      previewRef.current.srcdoc = activeFile.content;
    }
  };

  useEffect(() => {
    updatePreview();
  }, [activeFile.content]);

  // Code ausf√ºhren
  const runCode = async () => {
    try {
      const res = await fetch('http://localhost:8000/codestudio/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          language: activeFile.language,
          code: activeFile.content
        })
      });
      const data = await res.json();
      setOutput(data.output || data.error || 'Keine Ausgabe');
    } catch (err) {
      setOutput(`Fehler: ${err.message}`);
    }
  };

  // AI Chat
  const sendAIMessage = async (message) => {
    setAiMessages(prev => [...prev, { role: 'user', content: message }]);
    
    try {
      const res = await fetch('http://localhost:8000/chatgpt/stream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prompt: `Code Context:\nFile: ${activeFile.name}\nLanguage: ${activeFile.language}\nCode:\n${activeFile.content}\n\nFrage: ${message}`,
          model: 'gpt-4o',
          agent: 'code-assistant'
        })
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let aiResponse = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');
        
        for (const line of lines) {
          if (line.startsWith('data: ')) {
            try {
              const data = JSON.parse(line.slice(6));
              if (data.content) aiResponse += data.content;
            } catch (e) {}
          }
        }
      }

      setAiMessages(prev => [...prev, { role: 'assistant', content: aiResponse }]);
    } catch (err) {
      setAiMessages(prev => [...prev, { role: 'assistant', content: `Fehler: ${err.message}` }]);
    }
  };

  const autoFix = () => sendAIMessage('Analysiere und fixe alle Fehler. Gib korrigierten Code zur√ºck.');

  const updateCode = (newContent) => {
    setActiveFile(prev => ({ ...prev, content: newContent }));
    setFiles(files.map(f => f.id === activeFile.id ? { ...f, content: newContent } : f));
  };

  return (
    <div style={{
        margin: '0 auto 1rem',
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: '1rem',
        background: 'rgba(255, 255, 255, 0.05)',
        borderRadius: '12px',
        backdropFilter: 'blur(10px)'
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
          <Link href="/" style={{ color: 'white', textDecoration: 'none', fontSize: '1.5rem' }}>‚Üê</Link>
          <h1 style={{ fontSize: '1.8rem', margin: 0 }}>üé® Code Studio</h1>
        </div>
        
        <div style={{ display: 'flex', gap: '1rem' }}>
          <select
            value={language}
            onChange={(e) => setLanguage(e.target.value)}
            style={{
              padding: '0.5rem 1rem',
              background: 'rgba(255, 255, 255, 0.1)',
              border: '2px solid rgba(255, 255, 255, 0.2)',
              borderRadius: '8px',
              color: 'white',
              fontSize: '1rem'
            }}
          >
            {languages.map(lang => (
              <option key={lang} value={lang} style={{ background: '#1a1a2e' }}>
                {lang.toUpperCase()}
              </option>
            ))}
          </select>

          <button
            onClick={analyzeCode}
            style={{
              padding: '0.5rem 1.5rem',
              background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
              border: 'none',
              borderRadius: '8px',
              color: 'white',
              fontSize: '1rem',
              fontWeight: 'bold',
              cursor: 'pointer'
            }}
          >
            ü§ñ AI Analyze
          </button>
        </div>
      </div>

      {/* Editor Layout */}
      <div style={{
        maxWidth: '1600px',
        margin: '0 auto',
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '1rem',
        height: 'calc(100vh - 150px)'
      }}>
        {/* Code Editor */}
        <div style={{
          background: 'rgba(0, 0, 0, 0.4)',
          borderRadius: '12px',
          border: '2px solid rgba(255, 255, 255, 0.1)',
          padding: '1rem',
          display: 'flex',
          flexDirection: 'column'
        }}>
          <div style={{ 
            marginBottom: '1rem',
            fontSize: '1rem',
            fontWeight: 'bold',
            opacity: 0.8
          }}>
            üìù Editor
          </div>
          <textarea
            value={code}
            onChange={(e) => setCode(e.target.value)}
            style={{
              flex: 1,
              background: '#1a1a2e',
              border: '2px solid rgba(255, 255, 255, 0.15)',
              borderRadius: '8px',
              color: '#00f2fe',
              padding: '1rem',
              fontSize: '1rem',
              fontFamily: 'Monaco, Courier, monospace',
              resize: 'none',
              outline: 'none'
            }}
          />
        </div>

        {/* AI Suggestions */}
        <div style={{
          background: 'rgba(255, 255, 255, 0.05)',
          borderRadius: '12px',
          border: '2px solid rgba(255, 255, 255, 0.1)',
          padding: '1rem',
          display: 'flex',
          flexDirection: 'column'
        }}>
          <div style={{ 
            marginBottom: '1rem',
            fontSize: '1rem',
            fontWeight: 'bold',
            opacity: 0.8
          }}>
            ü§ñ AI Suggestions
          </div>
          <div style={{
            flex: 1,
            background: 'rgba(0, 0, 0, 0.2)',
            borderRadius: '8px',
            padding: '1rem',
            overflowY: 'auto',
            whiteSpace: 'pre-wrap',
            lineHeight: '1.6'
          }}>
            {aiSuggestion || 'Click "AI Analyze" to get code improvements, refactoring suggestions, and bug detection.'}
          </div>
        </div>
      </div>
    </div>
  )
}
